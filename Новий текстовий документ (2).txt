import cv2
import multiprocessing as mp
import time

def camera_process(frame_queue):
    # This process constantly reads frames and puts them in a queue
    cap = cv2.VideoCapture(0) # Use 0 for webcam
    while True:
        ret, frame = cap.read()
        if not ret:
            break
        if not frame_queue.full():
            frame_queue.put(frame)
    cap.release()

def motion_detection_process(frame_queue, result_queue):
    # This process performs motion detection on frames from the queue
    fgbg = cv2.createBackgroundSubtractorMOG2()
    while True:
        if not frame_queue.empty():
            frame = frame_queue.get()
            # Perform motion detection (e.g., background subtraction, contour finding)
            fgmask = fgbg.apply(frame)
            # ... further processing ...
            motion_detected = True # Placeholder for actual detection logic
            if motion_detected:
                result_queue.put("Motion detected!")

if __name__ == '__main__':
    # Set the start method for multiprocessing (important for compatibility)
    mp.set_start_method('spawn', force=True)

    frame_queue = mp.Queue(maxsize=10) # Bounded queue to prevent memory issues
    result_queue = mp.Queue()

    p1 = mp.Process(target=camera_process, args=(frame_queue,))
    p2 = mp.Process(target=motion_detection_process, args=(frame_queue, result_queue))

    p1.start()
    p2.start()
    
    # Main process can monitor result_queue or handle display (requires careful implementation)
    try:
        while True:
            if not result_queue.empty():
                print(result_queue.get())
            time.sleep(0.1)
    except KeyboardInterrupt:
        p1.terminate()
        p2.terminate()
        p1.join()
        p2.join()
